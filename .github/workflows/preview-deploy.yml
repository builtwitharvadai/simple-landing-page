name: Preview Deployment

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-preview:
    name: Build Preview
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Convert Markdown to HTML
        run: |
          python3 -m pip install --no-cache-dir markdown
          mkdir -p preview
          for file in *.md; do
            if [ -f "$file" ]; then
              python3 -m markdown "$file" > "preview/${file%.md}.html"
            fi
          done
      
      - name: Create index page
        run: |
          cat > preview/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Preview - PR #${{ github.event.pull_request.number }}</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 800px;
                margin: 40px auto;
                padding: 20px;
                line-height: 1.6;
              }
              h1 { color: #333; }
              .meta { color: #666; font-size: 0.9em; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>Preview Deployment</h1>
            <div class="meta">
              <p>Pull Request: #${{ github.event.pull_request.number }}</p>
              <p>Branch: ${{ github.head_ref }}</p>
              <p>Commit: ${{ github.sha }}</p>
            </div>
            <h2>Available Pages</h2>
            <ul>
          EOF
          
          for file in preview/*.html; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "index.html" ]; then
              filename=$(basename "$file")
              echo "      <li><a href=\"$filename\">$filename</a></li>" >> preview/index.html
            fi
          done
          
          cat >> preview/index.html << 'EOF'
            </ul>
          </body>
          </html>
          EOF
      
      - name: Upload preview artifact
        uses: actions/upload-artifact@v4
        with:
          name: preview-pr-${{ github.event.pull_request.number }}
          path: preview/
          retention-days: 7

  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: build-preview
    if: always() && needs.build-preview.result == 'success'
    
    environment:
      name: preview-pr-${{ github.event.pull_request.number }}
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Download preview artifact
        uses: actions/download-artifact@v4
        with:
          name: preview-pr-${{ github.event.pull_request.number }}
          path: preview
      
      - name: Configure Pages
        uses: actions/configure-pages@v4
      
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: preview
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deployment.outputs.page_url }}';
            const prNumber = ${{ github.event.pull_request.number }};
            const commitSha = '${{ github.sha }}';
            
            const comment = `## ðŸš€ Preview Deployment
            
            Your preview deployment is ready!
            
            **Preview URL:** ${previewUrl}
            
            ### Details
            - **PR:** #${prNumber}
            - **Commit:** \`${commitSha.substring(0, 7)}\`
            - **Branch:** \`${{ github.head_ref }}\`
            
            The preview will be automatically updated when you push new commits to this PR.
            
            ---
            *Preview deployments are retained for 7 days.*`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Deployment')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }